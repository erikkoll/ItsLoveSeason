<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Eric's Cave</title>
  <link rel="stylesheet" href="assets/styles.css" />

  <style>
    /* ===== Gate (modal) ===== */
    .gate-overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);display:grid;place-items:center;z-index:1000}
    .gate-card{background:#fff;border-radius:14px;max-width:560px;width:calc(100% - 2rem);padding:1.75rem;box-shadow:0 20px 60px rgba(0,0,0,.2);text-align:center}
    .gate-card h2{margin:0 0 .5rem;font-family:var(--font-serif)}
    .gate-card p{margin:.25rem 0 1rem;line-height:1.6}
    .gate-form{display:flex;gap:.5rem;justify-content:center;flex-wrap:wrap}
    .gate-form input[type="text"]{padding:.6rem .75rem;border:1px solid #ddd;border-radius:8px;min-width:200px;font-size:1rem}
    .gate-form button{padding:.6rem 1rem;border-radius:8px;border:1px solid #b8952b;background:#D4AF37;color:#111;font-weight:600;cursor:pointer}
    .gate-hint{min-height:1.25rem;color:#555;font-size:.95rem;margin-top:.4rem}
    .no-scroll{overflow:hidden}

    /* Blur until unlocked */
    #secret-content{transition:filter 220ms ease}
    #secret-content.blurred{filter:blur(10px);pointer-events:none;user-select:none}
    @media (prefers-reduced-motion:reduce){#secret-content{transition:none}}

    /* ===== Chess corner ===== */
    .chess-corner{max-width:1100px;margin:2rem auto;padding:0 1rem}
    .chess-title{text-align:center;font-family:var(--font-serif);margin-bottom:1rem}
    .chess-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1.2rem}
    @media (max-width:980px){.chess-grid{grid-template-columns:1fr 1fr}}
    @media (max-width:680px){.chess-grid{grid-template-columns:1fr}}

    .card{background:#fff;border:1px solid #eee;border-radius:12px;box-shadow:0 6px 14px rgba(0,0,0,.05);padding:1rem 1rem 1.2rem}
    .card h3{margin:0 0 .4rem;font-family:var(--font-serif)}
    .inline{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}

    .btn{display:inline-block;border-radius:8px;padding:.6rem 1rem;background:#f3e7b5;border:1px solid #dcc57b;color:#111;text-decoration:none;font-weight:600}
    .btn:hover{background:#eedc9a}
    .btn.outline{background:transparent;border-color:#d9c890;color:#a9861f}
    .btn.outline:hover{background:rgba(212,175,55,0.08)}

    .mini-rating{margin-top:.75rem;font-size:.95rem}
    .mini-rating #ratingList{margin-top:.25rem;display:grid;grid-template-columns:repeat(3,auto);gap:.6rem 1rem}

    /* Lichess embed: center and avoid letterboxing */
    .embed-wrap{
      position:relative;
      width:100%;
      max-width:420px;
      margin-inline:auto;
      aspect-ratio:1 / 1.22;   /* tall enough for header/moves */
      background:#222;         /* in case the iframe has transparent edges */
      border-radius:10px;
      overflow:hidden;
    }
    .embed-wrap iframe{position:absolute;inset:0;width:100%;height:100%;border:0}

    /* Bot board sizing */
    .board-wrap{width:100%;max-width:420px;margin:0 auto}
    #ericBotBoard{width:100%}
  </style>
</head>
<body>
  <main id="secret-content" class="blurred">
    <section style="max-width:820px;margin:2rem auto 0;padding:0 1rem;">
      <h1 class="story-main-title" style="margin-top:1rem;text-align:center;">Eric's Cave</h1>
    </section>

    <section class="chess-corner">
      <h2 class="chess-title">Chess corner</h2>

      <div class="chess-grid">
        <!-- Card 1 -->
        <article class="card">
          <h3>Challenge Eric</h3>
          <p>Up for a game? Challenge me on Lichess.</p>
          <a class="btn" href="https://lichess.org/@/erikkoll" target="_blank" rel="noopener">Open my Lichess profile ↗</a>

          <div class="mini-rating" id="ratingBox" hidden>
            <strong>Current ratings</strong>
            <div id="ratingList"></div>
          </div>
        </article>

        <!-- Card 2 -->
        <article class="card">
          <h3>Watch my best win</h3>
          <p>Replay the game I’m most proud of.</p>
          <div class="embed-wrap">
            <iframe id="gameEmbed" title="Lichess game replay" loading="lazy" allowfullscreen></iframe>
          </div>
        </article>

        <!-- Card 3 -->
        <article class="card">
          <h3>Play “Eric-level” bot</h3>
          <p>Stockfish with limited strength (≈1614 Elo). Choose a side and play!</p>

          <div class="board-wrap"><div id="ericBotBoard"></div></div>

          <div class="inline" style="margin-top:.6rem">
            <label><input type="radio" name="color" value="white"> You play White</label>
            <label><input type="radio" name="color" value="black" checked> You play Black</label>
            <button class="btn outline" id="newGameBtn" type="button">New game</button>
          </div>

          <p id="engineStatus" style="margin-top:.5rem;color:#666;font-size:.95rem;"></p>
        </article>
      </div>
    </section>
  </main>

  <!-- Gate overlay -->
  <div class="gate-overlay" id="gate" role="dialog" aria-modal="true" aria-labelledby="gateTitle">
    <div class="gate-card" role="document">
      <h2 id="gateTitle">Don’t Panic.</h2>
      <p>What is the answer to the ultimate question of Life, the Universe, and Everything?</p>
      <form class="gate-form" id="gateForm" autocomplete="off">
        <input type="text" id="answer" placeholder="Your answer" autofocus>
        <button type="submit">Submit</button>
      </form>
      <p class="gate-hint" id="gateHint" aria-live="polite"></p>
    </div>
  </div>

  <!-- Footer include -->
  <div id="site-footer"></div>
  <script>
    fetch('footer.html').then(r=>r.text()).then(h=>{document.getElementById('site-footer').outerHTML = h;});
  </script>

  <!-- Gate logic -->
  <script>
    (function(){
      const gate=document.getElementById('gate');
      const form=document.getElementById('gateForm');
      const input=document.getElementById('answer');
      const hint=document.getElementById('gateHint');
      const content=document.getElementById('secret-content');
      let tries=0;

      function openContent(){ gate.style.display='none'; content.classList.remove('blurred'); document.body.classList.remove('no-scroll'); try{localStorage.setItem('deep_thought_ok','1')}catch(e){} }
      function normalise(s){ return (s||'').trim().toLowerCase().replace(/[.,!?]/g,'').replace(/[-\s]+/g,' '); }

      try{ if(localStorage.getItem('deep_thought_ok')==='1'){ openContent(); return; } }catch(e){}
      document.body.classList.add('no-scroll');

      form.addEventListener('submit',e=>{
        e.preventDefault();
        const a=normalise(input.value);
        if(a==='42'||a==='forty two'||a==='forty-two'||a==='fortytwo'){ openContent(); return; }
        tries++; hint.textContent = tries===1?'Close… ask Deep Thought.':tries===2?'It’s a two-digit number.':'Promise: the answer is shorter than the question.'; input.select();
      });
    })();
  </script>

 <!-- ===== Libraries (pin stable UMD builds; add fallbacks) ===== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" referrerpolicy="no-referrer"></script>

<!-- chess.js 0.13.4 UMD (gives global `Chess`) -->
<script id="lib-chess" src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.min.js" referrerpolicy="no-referrer"></script>

<!-- chessboard.js 1.0.0 -->
<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css" />
<script id="lib-chessboard"
        src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"
        referrerpolicy="no-referrer"></script>

<!-- If either CDN is blocked, load a second source as a fallback -->
<script>
  (function () {
    function add(src){ var s=document.createElement('script'); s.src=src; document.head.appendChild(s); }
    // fallback for chess.js
    if (typeof window.Chess === 'undefined') {
      add('https://cdn.jsdelivr.net/gh/jhlywa/chess.js@0.13.4/chess.min.js');
    }
    // fallback for chessboard.js
    if (typeof window.Chessboard === 'undefined') {
      add('https://cdn.jsdelivr.net/npm/chessboard-js@1.0.0/dist/chessboard-1.0.0.min.js');
    }
  })();
</script>

<!-- Local Stockfish (place the file at /assets/vendor/stockfish.js) -->
<script src="assets/vendor/stockfish.js"></script>


  <!-- ===== Chess corner logic ===== -->
  <script>
    (function () {
      /* --- Best win embed --- */
      const BEST_ID = 'JGHVTwkz';
      document.getElementById('gameEmbed').src =
        `https://lichess.org/embed/game/${BEST_ID}?theme=auto&bg=auto`;

      /* --- Ratings (best-effort) --- */
      fetch('https://lichess.org/api/user/erikkoll')
        .then(r => r.ok ? r.json() : null)
        .then(data => {
          if(!data) return;
          const p = data.perfs || {};
          const items = [['Bullet',p.bullet?.rating],['Blitz',p.blitz?.rating],['Rapid',p.rapid?.rating]]
            .filter(([,r])=>typeof r==='number');
          if(items.length){
            const box = document.getElementById('ratingBox');
            const list= document.getElementById('ratingList');
            box.hidden=false;
            list.innerHTML = items.map(([k,v])=>`<span><strong>${k}:</strong> ${v}</span>`).join('');
          }
        }).catch(()=>{});

      /* --- Eric-level bot --- */
      const statusEl   = document.getElementById('engineStatus');
      const newBtn     = document.getElementById('newGameBtn');
      const colorRadios= Array.from(document.querySelectorAll('input[name="color"]'));
      const ELO_TARGET = 1614;

      if(typeof Chessboard === 'undefined' || typeof Chess === 'undefined'){
        statusEl.textContent = 'Could not load chess libraries.';
        return;
      }

      const game = new Chess();
      let board, engine, engineReady=false;
      let playerColor = (document.querySelector('input[name="color"]:checked')?.value) || 'white';

      function initBoard(){
        board = Chessboard('ericBotBoard', {
          draggable:true,
          position:'start',
          orientation:playerColor,
          onDragStart:(src,piece)=>{
            if(game.game_over()) return false;
            if(playerColor==='white' && piece.startsWith('b')) return false;
            if(playerColor==='black' && piece.startsWith('w')) return false;
          },
          onDrop:(src,tgt)=>{
            const mv = game.move({from:src,to:tgt,promotion:'q'});
            if(!mv) return 'snapback';
          },
          onSnapEnd:()=>{
            board.position(game.fen());
            maybeEngineMove();
          }
        });
        setTimeout(()=>board.resize(), 0);
        window.addEventListener('resize', ()=>board && board.resize());
      }

function createEngine(){
  try {
    // Factory build (global function)
    if (window.STOCKFISH || window.Stockfish) {
      return (window.STOCKFISH || window.Stockfish)();
    }
    // Worker-only build (no factory on window)
    return new Worker('assets/vendor/stockfish.js');
  } catch (e) {
    return null;
  }
}


      function initEngine(){
        engine = createEngine();
        if(!engine){ statusEl.textContent='Could not load Stockfish.'; return; }

        statusEl.textContent = 'Loading engine…';

        engine.onmessage = (e)=>{
          const line = (typeof e === 'string') ? e : e.data;
          if(!line) return;

          if(line === 'uciok'){ engine.postMessage('isready'); return; }
          if(line === 'readyok'){
            engineReady = true;
            statusEl.textContent = 'Engine ready';
            engine.postMessage('setoption name UCI_LimitStrength value true');
            engine.postMessage(`setoption name UCI_Elo value ${ELO_TARGET}`);
            engine.postMessage('setoption name Skill Level value 8');
            maybeEngineMove();
            return;
          }
          if(line.startsWith('bestmove')){
            const best = line.split(/\s+/)[1];
            if(best && best !== '(none)'){
              const from=best.slice(0,2), to=best.slice(2,4), promo=best.slice(4)||'q';
              game.move({from,to,promotion:promo});
              board.position(game.fen());
              statusEl.textContent='';
              maybeEngineMove();
            }
          }
        };

        engine.postMessage('uci');
      }

      function engineGo(){
        if(!engineReady) return;
        engine.postMessage(`position fen ${game.fen()}`);
        engine.postMessage('go movetime 1200');
        statusEl.textContent = 'Thinking…';
      }

      function maybeEngineMove(){
        const engineColor = (playerColor === 'white') ? 'b' : 'w';
        if(!game.game_over() && game.turn() === engineColor) engineGo();
      }

      function resetGame(){
        game.reset();
        board.orientation(playerColor);
        board.start();
        if(engine) engine.postMessage('ucinewgame');
        board.resize();
        maybeEngineMove();
      }

      colorRadios.forEach(r => r.addEventListener('change', ()=>{
        playerColor = document.querySelector('input[name="color"]:checked').value;
        resetGame();
      }));
      newBtn.addEventListener('click', resetGame);

      initBoard();
      initEngine();
      if(playerColor==='black') maybeEngineMove();
    })();
  </script>
</body>
</html>
